<!DOCTYPE html>
<html lang="en" style="height: 100%">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="data:;base64,=">
  <title>五子棋</title>
</head>
<body style="height: 100%; margin: 0; background: bisque">
<style>
  .message {
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    color: rgba(0,0,0,.85);
    font-size: 14px;
    font-variant: tabular-nums;
    line-height: 1.5715;
    list-style: none;
    -webkit-font-feature-settings: "tnum";
    font-feature-settings: "tnum";
    position: fixed;
    top: 8px;
    left: 0;
    z-index: 1010;
    width: 100%;
    pointer-events: none;
    text-align: center;
  }
  .message > div {
    padding: 6px;
  }
  .message > div > div {
    display: inline-block;
    padding: 12px 18px;
    background: #fff;
    border-radius: 2px;
    -webkit-box-shadow: 0 3px 6px -4px rgba(0,0,0,.12), 0 6px 16px 0 rgba(0,0,0,.08), 0 9px 28px 8px rgba(0,0,0,.05);
    box-shadow: 0 3px 6px -4px rgba(0,0,0,.12), 0 6px 16px 0 rgba(0,0,0,.08), 0 9px 28px 8px rgba(0,0,0,.05);
    pointer-events: all;
  }
</style>
<div id="message" class="message"></div>
<svg id="svg" viewBox="-76,-76,152,152" style="height: 100%; width: 100%" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <radialGradient id="black">
      <stop offset="0%" style="stop-color:#808080" />
      <stop offset="100%" style="stop-color:#111" />
    </radialGradient>
    <radialGradient id="white">
      <stop offset="0%" style="stop-color:#fff" />
      <stop offset="100%" style="stop-color:#ddd" />
    </radialGradient>
    <rect id="mark" x="-1" y="-1" width="2" height="2"/>
    <circle id="piece" r="4.2"/>
  </defs>
  <path stroke="brown" stroke-width="0.5" fill="none" d="m-70,-70h140v140h-140zm10,0v140m10,0v-140m10,0v140m10,0v-140m10,0v140m10,0v-140m10,0v140m10,0v-140m10,0v140m10,0v-140m10,0v140m10,0v-140m10,0v140m10,-10h-140m0,-10h140m0,-10h-140m0,-10h140m0,-10h-140m0,-10h140m0,-10h-140m0,-10h140m0,-10h-140m0,-10h140m0,-10h-140m0,-10h140m0,-10h-140"/>
  <use xlink:href="#mark"/>
  <use xlink:href="#mark" x="40" y="40"/>
  <use xlink:href="#mark" x="40" y="-40"/>
  <use xlink:href="#mark" x="-40" y="40"/>
  <use xlink:href="#mark" x="-40" y="-40"/>
</svg>
<script>
  const room = window.location.pathname;
  const online = room !== '/';
  let turn = !online;
  let black = true;
  let winner = null;
  let ws;
  const svg = document.getElementById('svg');
  const pieces = [];
  for (let x = 0; x < 15; x++) {
    pieces.push([]);
    for (let y = 0; y < 15; y++) {
      const _x = x;
      const _y = y;
      const piece = document.createElementNS('http://www.w3.org/2000/svg', 'use');
      pieces[x].push(piece);
      piece.setAttribute('x', (x * 10 - 70).toString());
      piece.setAttribute('y', (y * 10 - 70).toString());
      piece.setAttribute('fill-opacity', '0');
      piece.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '#piece');
      piece.addEventListener('mouseenter', () => {
        if (!turn || piece.getAttribute('fill-opacity') === '1') return;
        piece.setAttribute('fill', black ? 'url(#black)' : 'url(#white)');
        piece.setAttribute('fill-opacity', '0.5');
      });
      piece.addEventListener('mouseleave', () => {
        if (!turn || piece.getAttribute('fill-opacity') === '1') return;
        piece.setAttribute('fill-opacity', '0');
      });
      piece.addEventListener('click', () => {
        if (!turn || piece.getAttribute('fill-opacity') === '1') return;
        piece.setAttribute('fill', black ? 'url(#black)' : 'url(#white)');
        piece.setAttribute('fill-opacity', '1');
        setMark(_x, _y);
        if (online) {
          turn = false;
          ws.send(`${_x} ${_y}`);
        } else {
          black = !black;
        }
      });
      svg.appendChild(piece);
    }
  }
  const mark = document.createElementNS("http://www.w3.org/2000/svg", 'rect');
  mark.setAttribute('fill', 'red');
  mark.setAttribute('width', '2');
  mark.setAttribute('height', '2');
  mark.setAttribute('opacity', '0');
  svg.appendChild(mark);
  const setMark = (x, y) => {
    mark.setAttribute('x', (x * 10 - 71).toString());
    mark.setAttribute('y', (y * 10 - 71).toString());
    mark.setAttribute('opacity', '0.7');
    checkWinner(x, y);
    if (winner) {
      if (!online) {
        Message(`游戏结束，${winner === 'black' ? '黑' : '白'}棋胜利！`);
      } else {
        if ((winner === 'black' && black) || (winner === 'white' && !black)) {
          Message('你赢了！');
        } else {
          Message('你输了，下次加油！');
        }
      }
    }
  };

  const checkWinner = (x, y) => {
    const color = pieces[x][y].getAttribute('fill');
    if (x >= 4) {
      let ok = true;
      for (const i of [4, 3, 2, 1]) {
        if (pieces[x - i][y].getAttribute('fill-opacity') !== '1' || pieces[x - i][y].getAttribute('fill') !== color) {
          ok = false;
          break;
        }
      }
      if (ok) {
        winner = color === 'url(#black)' ? 'black' : 'white';
        return;
      }
      if (y >= 4) {
        let ok = true;
        for (const i of [4, 3, 2, 1]) {
          if (pieces[x - i][y - i].getAttribute('fill-opacity') !== '1' || pieces[x - i][y - i].getAttribute('fill') !== color) {
            ok = false;
            break;
          }
        }
        if (ok) {
          winner = color === 'url(#black)' ? 'black' : 'white';
          return;
        }
      }
      if (y <= 10) {
        let ok = true;
        for (const i of [4, 3, 2, 1]) {
          if (pieces[x - i][y + i].getAttribute('fill-opacity') !== '1' || pieces[x - i][y + i].getAttribute('fill') !== color) {
            ok = false;
            break;
          }
        }
        if (ok) {
          winner = color === 'url(#black)' ? 'black' : 'white';
          return;
        }
      }
    }
    if (x <= 10) {
      let ok = true;
      for (const i of [4, 3, 2, 1]) {
        if (pieces[x + i][y].getAttribute('fill-opacity') !== '1' || pieces[x + i][y].getAttribute('fill') !== color) {
          ok = false;
          break;
        }
      }
      if (ok) {
        winner = color === 'url(#black)' ? 'black' : 'white';
        return;
      }
      if (y >= 4) {
        let ok = true;
        for (const i of [4, 3, 2, 1]) {
          if (pieces[x + i][y - i].getAttribute('fill-opacity') !== '1' || pieces[x + i][y - i].getAttribute('fill') !== color) {
            ok = false;
            break;
          }
        }
        if (ok) {
          winner = color === 'url(#black)' ? 'black' : 'white';
          return;
        }
      }
      if (y <= 10) {
        let ok = true;
        for (const i of [4, 3, 2, 1]) {
          if (pieces[x + i][y + i].getAttribute('fill-opacity') !== '1' || pieces[x + i][y + i].getAttribute('fill') !== color) {
            ok = false;
            break;
          }
        }
        if (ok) {
          winner = color === 'url(#black)' ? 'black' : 'white';
          return;
        }
      }
    }
    if (y >= 4) {
      let ok = true;
      for (const i of [4, 3, 2, 1]) {
        if (pieces[x][y - i].getAttribute('fill-opacity') !== '1' || pieces[x][y - i].getAttribute('fill') !== color) {
          ok = false;
          break;
        }
      }
      if (ok) {
        winner = color === 'url(#black)' ? 'black' : 'white';
        return;
      }
    }
    if (y <= 10) {
      let ok = true;
      for (const i of [4, 3, 2, 1]) {
        if (pieces[x][y + i].getAttribute('fill-opacity') !== '1' || pieces[x][y + i].getAttribute('fill') !== color) {
          ok = false;
          break;
        }
      }
      if (ok) {
        winner = color === 'url(#black)' ? 'black' : 'white';
      }
    }
  };

  const messageDiv = document.getElementById('message');
  const Message = (content) => {
    const div = document.createElement('div');
    div.innerHTML = `<div>${content}</div>`;
    messageDiv.appendChild(div);
    setTimeout(() => messageDiv.removeChild(div), 2500);
  };

  if (online) {
    ws = new WebSocket(`ws://${window.location.host}${room}`);
    ws.onerror = (_ => Message('房间人满了，换一个房间吧'));
    ws.onmessage = (ev => {
      const text = ev.data;
      if (text === 'black') {
        turn = true;
        Message('您执黑棋，请下棋！');
      } else if (text === 'white') {
        black = false;
        Message('您执白棋！');
      } else {
        const [x, y] = text.split(' ').map(i => Number(i));
        const piece = pieces[x][y];
        piece.setAttribute('fill', black ? 'url(#white)' : 'url(#black)');
        piece.setAttribute('fill-opacity', '1');
        turn = true;
        setMark(x, y);
        if (!winner) Message('请下棋！');
      }
    });
  }
</script>
</body>
</html>